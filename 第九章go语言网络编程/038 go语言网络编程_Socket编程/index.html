



<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="go语言的学习笔记">
      
      
        <link rel="canonical" href="https://zangzhenhua1996.github.io/go/第九章go语言网络编程/038 go语言网络编程_Socket编程/">
      
      
        <meta name="author" content="臧珍华">
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="ja">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Socket编程 - 臧珍华的博客</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#757575">
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="grey" data-md-color-accent="pink">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#socket" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://zangzhenhua1996.github.io/go/" title="臧珍华的博客" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              臧珍华的博客
            </span>
            <span class="md-header-nav__topic">
              
                Socket编程
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://www.jianshu.com/u/21b46dcb7c44" title="前往 Github 仓库" class="md-source" data-md-source="">
  
  <div class="md-source__repository">
    I love AnFei
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link">
        介绍
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../第一章go语言开发环境配置/001 go语言开发环境配置/" class="md-tabs__link">
          安装
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../第二章go语言基本语法结构/002 go语言第一个例子/" class="md-tabs__link">
          基础语法
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../第三章go语言工程管理/013 go语言工作区/" class="md-tabs__link">
          工程管理
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../第四章go语言复合类型/016 go语言复合类型分类/" class="md-tabs__link">
          复合类型
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../第五章go语言面向对象编程/023 go语言面向对象编程概述/" class="md-tabs__link">
          面向对象编程
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../第六章go语言异常处理/027 go语言异常处理_error接口/" class="md-tabs__link">
          异常处理
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../第七章go语言文本文件处理/030 go语言文本文件处理_字符串操作/" class="md-tabs__link">
          文本文件处理
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../第八章go语言并发编程/034 go语言并发编程_概述/" class="md-tabs__link">
          并发编程
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../037 go语言网络编程_网络概述/" class="md-tabs__link md-tabs__link--active">
          网络编程
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://zangzhenhua1996.github.io/go/" title="臧珍华的博客" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    臧珍华的博客
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://www.jianshu.com/u/21b46dcb7c44" title="前往 Github 仓库" class="md-source" data-md-source="">
  
  <div class="md-source__repository">
    I love AnFei
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="介绍" class="md-nav__link">
      介绍
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      安装
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        安装
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../第一章go语言开发环境配置/001 go语言开发环境配置/" title="本地环境搭建" class="md-nav__link">
      本地环境搭建
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      基础语法
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        基础语法
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../第二章go语言基本语法结构/002 go语言第一个例子/" title="第一个例子" class="md-nav__link">
      第一个例子
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第二章go语言基本语法结构/003 go语言结构/" title="go语言结构" class="md-nav__link">
      go语言结构
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第二章go语言基本语法结构/004 go语言基础语法/" title="go语言基础语法" class="md-nav__link">
      go语言基础语法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第二章go语言基本语法结构/005 go变量定义/" title="go变量定义" class="md-nav__link">
      go变量定义
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第二章go语言基本语法结构/006 go内建变量类型/" title="go内建变量类型" class="md-nav__link">
      go内建变量类型
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第二章go语言基本语法结构/007 go常量与枚举/" title="go常量与枚举" class="md-nav__link">
      go常量与枚举
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第二章go语言基本语法结构/008 go语言运算符/" title="go语言运算符" class="md-nav__link">
      go语言运算符
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第二章go语言基本语法结构/009 go语言条件语句/" title="go语言条件语句" class="md-nav__link">
      go语言条件语句
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第二章go语言基本语法结构/010 go语言循环语句/" title="go语言循环语句" class="md-nav__link">
      go语言循环语句
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第二章go语言基本语法结构/011 go语言函数/" title="go语言函数" class="md-nav__link">
      go语言函数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第二章go语言基本语法结构/012 go语言变量作用域/" title="go语言变量作用域" class="md-nav__link">
      go语言变量作用域
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      工程管理
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        工程管理
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../第三章go语言工程管理/013 go语言工作区/" title="工作区" class="md-nav__link">
      工作区
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第三章go语言工程管理/014 go语言的包/" title="包" class="md-nav__link">
      包
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第三章go语言工程管理/015 go语言工程配置编译/" title="工程配置编译" class="md-nav__link">
      工程配置编译
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      复合类型
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        复合类型
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../第四章go语言复合类型/016 go语言复合类型分类/" title="分类" class="md-nav__link">
      分类
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第四章go语言复合类型/017 go语言复合类型指针/" title="指针" class="md-nav__link">
      指针
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第四章go语言复合类型/018 go语言复合类型数组/" title="数组" class="md-nav__link">
      数组
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第四章go语言复合类型/019 go语言复合类型切片(slice)/" title="切片" class="md-nav__link">
      切片
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第四章go语言复合类型/020 go语言复合类型map/" title="map" class="md-nav__link">
      map
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第四章go语言复合类型/021 go 语言结构体/" title="结构体" class="md-nav__link">
      结构体
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第四章go语言复合类型/022 go语言范围range/" title="范围range" class="md-nav__link">
      范围range
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      面向对象编程
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        面向对象编程
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../第五章go语言面向对象编程/023 go语言面向对象编程概述/" title="概述" class="md-nav__link">
      概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第五章go语言面向对象编程/024 go语言面向对象匿名组合/" title="匿名组合" class="md-nav__link">
      匿名组合
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第五章go语言面向对象编程/025 go语言面向对象_方法/" title="方法" class="md-nav__link">
      方法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第五章go语言面向对象编程/026 go语言面向对象_接口/" title="接口" class="md-nav__link">
      接口
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      异常处理
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        异常处理
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../第六章go语言异常处理/027 go语言异常处理_error接口/" title="error接口" class="md-nav__link">
      error接口
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第六章go语言异常处理/028 go语言异常处理_panic/" title="panic" class="md-nav__link">
      panic
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第六章go语言异常处理/029 go语言异常处理_recover/" title="recover" class="md-nav__link">
      recover
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      文本文件处理
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        文本文件处理
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../第七章go语言文本文件处理/030 go语言文本文件处理_字符串操作/" title="字符串操作" class="md-nav__link">
      字符串操作
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第七章go语言文本文件处理/031 go语言文本文件处理_正则表达式/" title="正则表达式" class="md-nav__link">
      正则表达式
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第七章go语言文本文件处理/032 go语言文本文件处理_JSON处理/" title="JSON处理" class="md-nav__link">
      JSON处理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第七章go语言文本文件处理/033 go语言文本文件处理_文本操作/" title="文本操作" class="md-nav__link">
      文本操作
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      并发编程
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        并发编程
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../第八章go语言并发编程/034 go语言并发编程_概述/" title="概述" class="md-nav__link">
      概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第八章go语言并发编程/035 go语言并发编程_goroutine/" title="goroutine" class="md-nav__link">
      goroutine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../第八章go语言并发编程/036 go语言并发编程_channel/" title="channel" class="md-nav__link">
      channel
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10" checked>
    
    <label class="md-nav__link" for="nav-10">
      网络编程
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        网络编程
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../037 go语言网络编程_网络概述/" title="概述" class="md-nav__link">
      概述
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Socket编程
      </label>
    
    <a href="./" title="Socket编程" class="md-nav__link md-nav__link--active">
      Socket编程
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#socket_1" class="md-nav__link">
    什么是Socket
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcpcs" class="md-nav__link">
    TCP的C/S架构
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    示例程序1
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    服务器代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    客服端代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    运行结果
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    简单版并发服务器
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tcp" class="md-nav__link">
    TCP服务器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client" class="md-nav__link">
    Client 客户端
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    文件传输
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    原理分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    获取文件属性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    传输文件发送方
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    传输文件接收方
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    并发聊天服务器
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    原理分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    代码实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../039 go语言网络编程_Http编程/" title="Http编程" class="md-nav__link">
      Http编程
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#socket_1" class="md-nav__link">
    什么是Socket
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcpcs" class="md-nav__link">
    TCP的C/S架构
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    示例程序1
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    服务器代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    客服端代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    运行结果
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    简单版并发服务器
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tcp" class="md-nav__link">
    TCP服务器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client" class="md-nav__link">
    Client 客户端
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    文件传输
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    原理分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    获取文件属性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    传输文件发送方
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    传输文件接收方
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    并发聊天服务器
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    原理分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    代码实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="socket">Socket编程<a class="headerlink" href="#socket" title="Permanent link">&para;</a></h1>
<h2 id="socket_1">什么是Socket<a class="headerlink" href="#socket_1" title="Permanent link">&para;</a></h2>
<p>Socket起源于Unix，<mark>而Unix基本哲学之一就是“一切皆文件”</mark> ，都可以用“打开open –&gt; 读写write/read –&gt; 关闭close”模式来操作。Socket就是该模式的一个实现，网络的Socket数据传输是一种特殊的I/O，Socket也是一种文件描述符。<mark>Socket也具有一个类似于打开文件的函数调用：Socket()，该函数返回一个整型的Socket描述符，随后的连接建立、数据传输等操作都是通过该Socket实现的。</mark></p>
<p>常用的Socket类型有两种：<mark>流式Socket（SOCK_STREAM）和数据报式Socket（SOCK_DGRAM）。</mark> 流式是一种面向连接的Socket，针对于面向连接的TCP服务应用；数据报式Socket是一种无连接的Socket，对应于无连接的UDP服务应用。</p>
<h2 id="tcpcs">TCP的C/S架构<a class="headerlink" href="#tcpcs" title="Permanent link">&para;</a></h2>
<p><img alt="无标题" src="../038 go语言网络编程_Socket编程.image/clip_image002.png" /></p>
<p>CS模型介绍</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">cs模型</span><span class="p">(</span><span class="nx">client</span> <span class="nx">and</span> <span class="nx">server</span> <span class="p">)</span><span class="err">：</span><span class="nx">客户端和服务器</span>


<span class="nx">客户端</span>   <span class="o">======</span><span class="p">=&gt;</span>  <span class="nx">客户</span>
<span class="mi">1</span><span class="err">）</span><span class="nx">主动请求服务</span>


<span class="nx">服务器</span>  <span class="o">========</span><span class="err">》</span> <span class="nx">客服</span>
<span class="mi">2</span><span class="err">）</span><span class="nx">被动提供服务</span>


<span class="nx">brower</span><span class="o">/</span><span class="nx">server</span>
<span class="nx">bs模型</span>

<span class="nx">brower</span> <span class="o">====</span><span class="p">=</span><span class="err">》</span> <span class="nx">客户端</span><span class="err">，</span> <span class="nx">html</span>
</pre></div>
</td></tr></table>

<h2 id="1">示例程序1<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h4 id="_1">服务器代码<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;net&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//监听</span>
    <span class="nx">listener</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1:8001&quot;</span><span class="p">)</span>  <span class="c1">//使用Listen进行监听</span>
    <span class="c1">//判断是否有错误,有错误就不要执行了</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">defer</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>  <span class="c1">//最后使用 延迟调用函数defer 关闭监听</span>

    <span class="c1">//阻塞等待用户链接</span>
    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">Accept</span><span class="p">()</span> <span class="c1">//调用方法</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="c1">//接收用户的请求</span>
    <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span> <span class="c1">//创建1024大小的缓冲区切片</span>
    <span class="nx">n</span><span class="p">,</span> <span class="nx">err1</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>  <span class="c1">//将接收到的内容进行读取到缓冲区,n是占用了多少的切片</span>
    <span class="k">if</span> <span class="nx">err1</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;err1 = &quot;</span><span class="p">,</span> <span class="nx">err1</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;buf = &quot;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">]))</span>  <span class="c1">//将切片转换为string进行打印</span>

    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span> <span class="c1">//关闭当前用户链接,前面还有关闭监听,先关闭当前用户链接再关闭监听,defer的先进后出</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>#### Netcat 安装使用教程</p>
<ul>
<li>将压缩包解压到常用的软件安装盘</li>
</ul>
<p><img alt="image-20200120181247081" src="../038 go语言网络编程_Socket编程.image/image-20200120181247081.png" /></p>
<ul>
<li>有两个可执行文件</li>
</ul>
<p><img alt="image-20200120181905808" src="../038 go语言网络编程_Socket编程.image/image-20200120181905808.png" /></p>
<ul>
<li>添加环境变量</li>
</ul>
<p><img alt="image-20200120184000028" src="../038 go语言网络编程_Socket编程.image/image-20200120184000028.png" /></p>
<ul>
<li>使用</li>
</ul>
<p><img alt="image-20200120185957868" src="../038 go语言网络编程_Socket编程.image/image-20200120185957868.png" /></p>
<h4 id="_2">客服端代码<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;net&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//主动连接服务器,使用的是Dial函数</span>
    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1:8001&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>  <span class="c1">//最后关闭连接</span>

    <span class="c1">//发送数据</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;are u ok?&quot;</span><span class="p">))</span>  <span class="c1">//发送字节切片(类型转换)</span>

<span class="p">}</span>
</pre></div>
</td></tr></table>

<h4 id="_3">运行结果<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p><img alt="录制_2020_01_20_19_11_14_278" src="../038 go语言网络编程_Socket编程.image/录制_2020_01_20_19_11_14_278.gif" /></p>
<h2 id="_4">简单版并发服务器<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="tcp">TCP服务器<a class="headerlink" href="#tcp" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;net&quot;</span>
    <span class="s">&quot;strings&quot;</span>
<span class="p">)</span>

<span class="c1">//处理用户请求</span>
<span class="kd">func</span> <span class="nx">HandleConn</span><span class="p">(</span><span class="nx">conn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//函数传递的类型是net.Conn</span>
    <span class="c1">//函数调用完毕，自动关闭conn</span>
    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="c1">//获取客户端的网络地址信息  RemoteAddr 远程地址</span>
    <span class="nx">addr</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">RemoteAddr</span><span class="p">().</span><span class="nx">String</span><span class="p">()</span>  <span class="c1">//获取地址信息转换成字符串</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="s">&quot; conncet sucessful&quot;</span><span class="p">)</span>

    <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>  <span class="c1">//定义一个切片接收数据</span>

    <span class="k">for</span> <span class="p">{</span>
        <span class="c1">//读取用户数据</span>
        <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>  <span class="c1">//使用Read函数读取数据到buf中,并返回占用的字节数</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;[%s]: %s\n&quot;</span><span class="p">,</span> <span class="nx">addr</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">]))</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;len = &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">])))</span>

        <span class="k">if</span> <span class="s">&quot;exit&quot;</span> <span class="o">==</span> <span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span> <span class="c1">//nc测试</span>
        <span class="c1">//if &quot;exit&quot; == string(buf[:n-2]) { //自己写的客户端测试, 发送时，多了2个字符, &quot;\r\n&quot;</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="s">&quot; exit&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="c1">//把数据转换为大写，再给用户发送</span>
        <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">ToUpper</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">]))))</span>  <span class="c1">//strings.ToUpper 将字符串转换为全大写</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//监听</span>
    <span class="nx">listener</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1:8001&quot;</span><span class="p">)</span>  <span class="c1">//本机的服务器的IP及port可以固定</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">defer</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="c1">//接收多个用户</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">Accept</span><span class="p">()</span>  <span class="c1">//可以持续的接收连接</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="c1">//处理用户请求, 新建一个协程</span>
        <span class="k">go</span> <span class="nx">HandleConn</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>  <span class="c1">//给每一个用户请求一个协程去处理(协程的好处出现了)</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>执行结果:使用NetCat 进行测试</p>
<p><img alt="录制_2020_01_20_19_34_48_891" src="../038 go语言网络编程_Socket编程.image/录制_2020_01_20_19_34_48_891.gif" /></p>
<h3 id="client">Client 客户端<a class="headerlink" href="#client" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;net&quot;</span>
    <span class="s">&quot;os&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//主动连接服务器</span>
    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1:8001&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;net.Dial err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="c1">//main调用完毕，关闭连接</span>
    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//从键盘输入内容，给服务器发送内容</span>
        <span class="nx">str</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="c1">//从键盘读取内容， 放在str   //os.Stdin 输入流</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;os.Stdin. err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="p">}</span>

            <span class="c1">//把输入的内容给服务器发送</span>
            <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">str</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="c1">//接收服务器回复的数据</span>
    <span class="c1">//切片缓冲</span>
    <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="c1">//接收服务器的请求</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;conn.Read err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">]))</span> <span class="c1">//打印接收到的内容, 转换为字符串再打印</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<blockquote>
<p>注意更改服务端判断退出的代码</p>
</blockquote>
<p><img alt="image-20200120201506008" src="../038 go语言网络编程_Socket编程.image/image-20200120201506008.png" /></p>
<p>执行结果</p>
<p><img alt="录制_2020_01_20_20_16_09_679" src="../038 go语言网络编程_Socket编程.image/录制_2020_01_20_20_16_09_679.gif" /></p>
<h2 id="_5">文件传输<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="_6">原理分析<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p><img alt="image-20200121140420395" src="../038 go语言网络编程_Socket编程.image/image-20200121140420395.png" /></p>
<h3 id="_7">获取文件属性<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;os&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">list</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span>   <span class="c1">//第一个参数是程序路径本身 ,第二个是文件的路径(文件名(相对路径))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;useage: xxx file&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">fileName</span> <span class="o">:=</span> <span class="nx">list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">//获取传递来的文件名(或者路径)</span>

    <span class="nx">info</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stat</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span>  <span class="c1">//返回该文件的一系列参数</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>  <span class="c1">//要是有错误就打印什么错</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="c1">//打印文件名</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;name = &quot;</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Name</span><span class="p">())</span>
    <span class="c1">//打印文件大小</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;size = &quot;</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Size</span><span class="p">())</span>

<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>运行结果</p>
<p><img alt="录制_2020_01_21_14_20_39_317" src="../038 go语言网络编程_Socket编程.image/录制_2020_01_21_14_20_39_317.gif" /></p>
<h3 id="_8">传输文件发送方<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;io&quot;</span>
    <span class="s">&quot;net&quot;</span>
    <span class="s">&quot;os&quot;</span>
<span class="p">)</span>

<span class="c1">//发送文件内容</span>
<span class="kd">func</span> <span class="nx">SendFile</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">conn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//以只读方式打开文件</span>
    <span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>  <span class="c1">//使用Open函数打开该路径文件</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;os.Open err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">defer</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>  <span class="c1">//最后要关闭</span>

    <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>  <span class="c1">//缓冲区设置为4K大小</span>

    <span class="c1">//读文件内容，读多少发多少，一点不差</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="c1">//从文件读取内容,每次读取都是缓冲区大小的字节</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>  <span class="c1">//读到头了</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;文件发送完毕&quot;</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;f.Read err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">return</span>
        <span class="p">}</span>

        <span class="c1">//发送内容</span>
        <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span> <span class="c1">//给服务器发送内容,读取多少发送多少</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//提示输入文件</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;请输入需要传输的文件：&quot;</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">path</span> <span class="kt">string</span>  <span class="c1">//先声明一个文件名的类型</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">path</span><span class="p">)</span> <span class="c1">//获取文件路径.=,使用&amp;获取</span>

    <span class="c1">//获取文件名 info.Name()</span>
    <span class="nx">info</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stat</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>  <span class="c1">//获取该文件的众多参数</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;os.Stat err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="c1">//主动连接服务器</span>
    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err1</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1:8001&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err1</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;net.Dial err1 = &quot;</span><span class="p">,</span> <span class="nx">err1</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>  <span class="c1">//最后要关闭连接</span>

    <span class="c1">//给接收方，先发送文件名</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">Name</span><span class="p">()))</span>  <span class="c1">//将文件名转化成字节切片,发送</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;conn.Write err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="c1">//接收对方的回复，如果回复&quot;ok&quot;， 说明对方准备好，可以发文件</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="kt">int</span> <span class="c1">//提前声明n ,后面自动推导也是可以的</span>
    <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

    <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;conn.Read err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="s">&quot;ok&quot;</span> <span class="o">==</span> <span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">//发送文件内容</span>
        <span class="nx">SendFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">conn</span><span class="p">)</span>  <span class="c1">//调用发送文件的函数,传递的是参数是路径以及连接的服务器</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="_9">传输文件接收方<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;io&quot;</span>
    <span class="s">&quot;net&quot;</span>
    <span class="s">&quot;os&quot;</span>
<span class="p">)</span>

<span class="c1">//接收文件内容</span>
<span class="kd">func</span> <span class="nx">RecvFile</span><span class="p">(</span><span class="nx">fileName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">conn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//新建文件</span>
    <span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span>

    <span class="k">defer</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;os.Create err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1">//接收多少，写多少，一点不差</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="c1">//接收对方发过来的文件内容</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;文件接收完毕&quot;</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;conn.Read err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;n == 0 文件接收完毕&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="p">}</span>

        <span class="nx">f</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span> <span class="c1">//往文件写入内容</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//监听</span>
    <span class="nx">listenner</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1:8001&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;net.Listen err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">defer</span> <span class="nx">listenner</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="c1">//阻塞等待用户连接</span>
    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err1</span> <span class="o">:=</span> <span class="nx">listenner</span><span class="p">.</span><span class="nx">Accept</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err1</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;listenner.Accept err = &quot;</span><span class="p">,</span> <span class="nx">err1</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="kt">int</span>
    <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="c1">//读取对方发送的文件名</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;conn.Read err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">fileName</span> <span class="o">:=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>

    <span class="c1">//回复&quot;ok&quot;</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">))</span>

    <span class="c1">//接收文件内容</span>
    <span class="nx">RecvFile</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span> <span class="nx">conn</span><span class="p">)</span>

<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>使用</p>
<p><img alt="image-20200121145546814" src="../038 go语言网络编程_Socket编程.image/image-20200121145546814.png" /></p>
<h2 id="_10">并发聊天服务器<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<h3 id="_11">原理分析<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p><img alt="image-20200121145638405" src="../038 go语言网络编程_Socket编程.image/image-20200121145638405.png" /></p>
<h3 id="_12">代码实现<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;net&quot;</span>
    <span class="s">&quot;strings&quot;</span>
    <span class="s">&quot;time&quot;</span>
<span class="p">)</span>



<span class="kd">type</span> <span class="nx">Client</span> <span class="kd">struct</span> <span class="p">{</span>  <span class="c1">//定义一个结构体用来存储不同的数据</span>
    <span class="nx">C</span>    <span class="kd">chan</span> <span class="kt">string</span> <span class="c1">//用户发送数据的管道</span>
    <span class="nx">Name</span> <span class="kt">string</span>      <span class="c1">//用户名</span>
    <span class="nx">Addr</span> <span class="kt">string</span>      <span class="c1">//网络地址</span>
<span class="p">}</span>

<span class="c1">//保存在线用户   cliAddr =====&gt; Client</span>
<span class="kd">var</span> <span class="nx">onlineMap</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">Client</span>     <span class="c1">//声明键值对字典用来保存在线用户,下面需要使用make进行初始化</span>

<span class="kd">var</span> <span class="nx">messaage</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">string</span><span class="p">)</span>   <span class="c1">////存储转发信息的通道</span>

<span class="c1">//新开一个协程，转发消息，只要有消息来了，遍历map, 给map每个成员都发送此消息</span>
<span class="kd">func</span> <span class="nx">Manager</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//给map分配空间,只是声明只有 nil 必须初始化才能使用</span>
    <span class="nx">onlineMap</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">Client</span><span class="p">)</span>  <span class="c1">//因为这个协程是最早开启的,只会分配一次的map空间,只声明是不能使用的</span>

    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">msg</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">messaage</span> <span class="c1">//没有消息前，这里会阻塞</span>

        <span class="c1">//遍历map, 给map每个成员都发送此消息</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cli</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">onlineMap</span> <span class="p">{</span>
            <span class="nx">cli</span><span class="p">.</span><span class="nx">C</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">WriteMsgToClient</span><span class="p">(</span><span class="nx">cli</span> <span class="nx">Client</span><span class="p">,</span> <span class="nx">conn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">C</span> <span class="p">{</span> <span class="c1">//给当前客户端发送信息,cli.C是通道,只有有数据才行写入</span>
        <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">msg</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="c1">// 第7步 广播信息的创建</span>
<span class="kd">func</span> <span class="nx">MakeMsg</span><span class="p">(</span><span class="nx">cli</span> <span class="nx">Client</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">buf</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">buf</span> <span class="p">=</span> <span class="s">&quot;[&quot;</span> <span class="o">+</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">Addr</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span> <span class="o">+</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">Name</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">msg</span>

    <span class="k">return</span>
<span class="p">}</span>

<span class="c1">// 第5步,进行连接的处理</span>
<span class="kd">func</span> <span class="nx">HandleConn</span><span class="p">(</span><span class="nx">conn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//处理用户链接</span>
    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="c1">//获取客户端的网络地址</span>
    <span class="nx">cliAddr</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">RemoteAddr</span><span class="p">().</span><span class="nx">String</span><span class="p">()</span>

    <span class="c1">//创建一个结构体, 默认，用户名和网络地址一样</span>
    <span class="nx">cli</span> <span class="o">:=</span> <span class="nx">Client</span><span class="p">{</span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">string</span><span class="p">),</span> <span class="nx">cliAddr</span><span class="p">,</span> <span class="nx">cliAddr</span><span class="p">}</span>
    <span class="c1">//把结构体添加到map</span>
    <span class="nx">onlineMap</span><span class="p">[</span><span class="nx">cliAddr</span><span class="p">]</span> <span class="p">=</span> <span class="nx">cli</span>   <span class="c1">//键使用网络地址作为唯一值</span>

    <span class="c1">//新开一个协程，专门给当前客户端发送信息   第6步</span>
    <span class="k">go</span> <span class="nx">WriteMsgToClient</span><span class="p">(</span><span class="nx">cli</span><span class="p">,</span> <span class="nx">conn</span><span class="p">)</span>
    <span class="c1">//广播某个在线</span>
    <span class="c1">//messaage &lt;- &quot;[&quot; + cli.Addr + &quot;]&quot; + cli.Name + &quot;: login&quot;</span>
    <span class="nx">messaage</span> <span class="o">&lt;-</span> <span class="nx">MakeMsg</span><span class="p">(</span><span class="nx">cli</span><span class="p">,</span> <span class="s">&quot;login&quot;</span><span class="p">)</span>  <span class="c1">//用来广播的信息</span>
    <span class="c1">//提示，我是谁</span>
    <span class="nx">cli</span><span class="p">.</span><span class="nx">C</span> <span class="o">&lt;-</span> <span class="nx">MakeMsg</span><span class="p">(</span><span class="nx">cli</span><span class="p">,</span> <span class="s">&quot;I am here&quot;</span><span class="p">)</span>  <span class="c1">//写入以后给当前客户端发送消息</span>

    <span class="nx">isQuit</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>  <span class="c1">//对方是否主动退出</span>
    <span class="nx">hasData</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="c1">//对方是否有数据发送</span>

    <span class="c1">//新建一个协程，接收用户发送过来的数据  第8步</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>  <span class="c1">//定义一个切片用来读取数据的</span>
        <span class="k">for</span> <span class="p">{</span>   <span class="c1">//循环别忘记加</span>
            <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">//对方断开，或者，出问题</span>
                <span class="nx">isQuit</span> <span class="o">&lt;-</span> <span class="kc">true</span> <span class="c1">//对方退出了设置一个通道的断开标志位为true</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;conn.Read err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="c1">// 当前客户端发送的信息需要进行转发</span>
            <span class="nx">msg</span> <span class="o">:=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">//通过windows nc测试，多一个换行</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">msg</span> <span class="o">==</span> <span class="s">&quot;who&quot;</span> <span class="p">{</span>
                <span class="c1">//遍历map，给当前用户发送所有成员  //第10步 查询有哪些在线用户</span>
                <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;user list:\n&quot;</span><span class="p">))</span>
                <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">tmp</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">onlineMap</span> <span class="p">{</span>
                    <span class="nx">msg</span> <span class="p">=</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">Addr</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">Name</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span>
                    <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">msg</span><span class="p">))</span>
                <span class="p">}</span>

                <span class="c1">//第11步 修改当前用户名</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="nx">msg</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;rename&quot;</span> <span class="p">{</span>
                <span class="c1">// rename|mike</span>
                <span class="nx">name</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="s">&quot;|&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">//查看需要修改成什么名</span>
                <span class="nx">cli</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="nx">name</span> <span class="c1">//进行名字的修改</span>
                <span class="nx">onlineMap</span><span class="p">[</span><span class="nx">cliAddr</span><span class="p">]</span> <span class="p">=</span> <span class="nx">cli</span> <span class="c1">//修改该键对应的结构体</span>
                <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;rename ok\n&quot;</span><span class="p">))</span>  <span class="c1">//返回是否改名成功</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">//转发此内容 第9步</span>
                <span class="nx">messaage</span> <span class="o">&lt;-</span> <span class="nx">MakeMsg</span><span class="p">(</span><span class="nx">cli</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="nx">hasData</span> <span class="o">&lt;-</span> <span class="kc">true</span> <span class="c1">//代表有数据</span>
        <span class="p">}</span>

    <span class="p">}()</span> <span class="c1">//别忘了()</span>

    <span class="k">for</span> <span class="p">{</span>
        <span class="c1">//通过select检测channel的流动 //第12步用户主动退出</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">isQuit</span><span class="p">:</span> <span class="c1">//使用select进行检测,如果有退出的标志位,则删除此用户</span>
            <span class="nb">delete</span><span class="p">(</span><span class="nx">onlineMap</span><span class="p">,</span> <span class="nx">cliAddr</span><span class="p">)</span>            <span class="c1">//当前用户从map移除</span>
            <span class="nx">messaage</span> <span class="o">&lt;-</span> <span class="nx">MakeMsg</span><span class="p">(</span><span class="nx">cli</span><span class="p">,</span> <span class="s">&quot;login out&quot;</span><span class="p">)</span> <span class="c1">//广播谁下线了</span>

            <span class="k">return</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">hasData</span><span class="p">:</span>
           <span class="c1">//  有数据标志位就不用管</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nx">After</span><span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">):</span> <span class="c1">//60s后   //60s后将当前用户移除</span>
            <span class="nb">delete</span><span class="p">(</span><span class="nx">onlineMap</span><span class="p">,</span> <span class="nx">cliAddr</span><span class="p">)</span>                     <span class="c1">//当前用户从map移除</span>
            <span class="nx">messaage</span> <span class="o">&lt;-</span> <span class="nx">MakeMsg</span><span class="p">(</span><span class="nx">cli</span><span class="p">,</span> <span class="s">&quot;time out leave out&quot;</span><span class="p">)</span> <span class="c1">//广播谁下线了</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//监听 第1步</span>
    <span class="nx">listener</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;:8001&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;net.Listen err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">defer</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="c1">//新开一个协程，转发消息，只要有消息来了，遍历map, 给map每个成员都发送此消息  4</span>
    <span class="k">go</span> <span class="nx">Manager</span><span class="p">()</span>  <span class="c1">//第4步</span>

    <span class="c1">//主协程，循环阻塞等待用户链接  第2步</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">Accept</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;listener.Accept err = &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="k">continue</span>   <span class="c1">//防止整个程序的中断</span>
        <span class="p">}</span>

        <span class="k">go</span> <span class="nx">HandleConn</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span> <span class="c1">//处理用户链接 第3步</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table>

<blockquote>
<p>需要结合上面的原理分析详细的分析代码的实现</p>
</blockquote>
<p>执行结果</p>
<p><img alt="录制_2020_01_22_09_01_31_758" src="../038 go语言网络编程_Socket编程.image/录制_2020_01_22_09_01_31_758.gif" /></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../037 go语言网络编程_网络概述/" title="概述" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  上一页
                </span>
                概述
              </span>
            </div>
          </a>
        
        
          <a href="../039 go语言网络编程_Http编程/" title="Http编程" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  下一页
                </span>
                Http编程
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        <!-- powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a> -->
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.ac79c3b0.js"></script>
      
        
        
          
          <script src="../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
                <script src="../../assets/javascripts/lunr/tinyseg.js"></script>
              
              
                <script src="../../assets/javascripts/lunr/lunr.ja.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="../../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>